<!DOCTYPE html>
<html>
<head>
    
<meta charset="utf-8">

<title>tcp通信send消息遇到的问题-SIGPIPE的处理</title>

<style type="text/css">
    p{
    text-indent: 2em; /*em是相对单位,2em即现在一个字大小的两倍*/
    }
 </style>

</head>
<body>
 
<h1>问题</h1>

<p>在自己写demo的过程中发现这个问题,现象是<b>客户端在发送数据完毕后关闭连接,此时发现服务端程序崩溃</b></p>

<p>使用wireshark抓包,分析最后的状态</p>
<pre>
            //端口57310是客户端    端口9999是服务端

            TCP	68	57310 → 9999 [FIN, ACK] Seq=201 Ack=21 Win=65536 Len=0 TSval=409058450 TSecr=409058450
            
            TCP	68	9999 → 57310 [ACK] Seq=21 Ack=202 Win=65536 Len=0 TSval=409058491 TSecr=409058450
            
            TCP	88	9999 → 57310 [PSH, ACK] Seq=21 Ack=202 Win=65536 Len=20 TSval=409058648 TSecr=409058450 [TCP segment of a reassembled PDU]
            
            //可见最后是客户端向服务端发送了一个RST标志位
            TCP	56	57310 → 9999 [RST] Seq=202 Win=0 Len=0
</pre>

<br>
<hr>

<h1>问题产生说明</h1>

<p>由上面的捕获的网络数据可知,在最后客户端给服务端发送了一个RST包,现在已经不知道当时是什么情况导致客户端会发送RST包(应该是出现了什么异常),不过这不影响后续说明</p>

<p>问题的原因在于,服务端在接收了RST包后,后续还在向对应的socket中写入数据(这是四次挥手阶段,服务端会发发送剩余数据给客户端),由此触发内核生成并发送SIGPIPE信号(该信号默认会使进程终止)</p>

<br>
<hr>

<h1>解决方法</h1>
<p>处理或忽略SIGPIPE信号</p>


</body>
</html>





